<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFF Premium Orders</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #008060; --bg: #f6f6f7; --white: #ffffff; --text: #202223; --sidebar-width: 240px; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: var(--sidebar-width); background: var(--white); border-right: 1px solid #e1e3e5; display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; }
        .brand { font-size: 20px; font-weight: 700; color: var(--primary); padding: 0 20px 20px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        
        .menu-item { padding: 12px 20px; cursor: pointer; font-weight: 500; color: #5c5f62; display: flex; align-items: center; gap: 10px; transition: 0.2s; text-decoration: none; }
        .menu-item:hover { background: #f1f2f3; color: var(--primary); }
        .menu-item.active { background: #edfffa; color: var(--primary); font-weight: 600; }

        /* Main Container Relative for Absolute Pagination */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .top-bar { background: var(--white); padding: 15px 20px; border-bottom: 1px solid #e1e3e5; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .input-group { display: flex; align-items: center; gap: 5px; }
        input, select { padding: 8px 12px; border: 1px solid #babfc3; border-radius: 4px; font-size: 14px; outline: none; }
        input:focus { border-color: var(--primary); }
        .btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn:hover { background: #006e52; }
        .btn-secondary { background: #fff; border: 1px solid #babfc3; color: #333; }
        .btn-secondary:hover { background: #f6f6f7; }
        .btn-sm { padding: 4px 8px; font-size: 11px; margin-top: 5px; }
        .btn-link { background: none; border: none; color: #008060; padding: 0; font-size: 12px; text-decoration: underline; cursor: pointer; margin-bottom: 5px; }
        
        .btn-disabled { background: #e4e5e7; color: #8c9196; cursor: not-allowed; border: 1px solid #e4e5e7; }
        .btn-disabled:hover { background: #e4e5e7; }

        /* Content Area Padding for Pagination */
        .content-area { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        
        .order-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; padding: 15px; display: flex; flex-direction: column; gap: 10px; border-left: 4px solid var(--primary); }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .order-id { font-weight: 700; font-size: 16px; color: var(--primary); }
        .order-date { font-size: 12px; color: #6d7175; }
        .order-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .price-tag { font-weight: 700; font-size: 15px; }
        
        .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; text-transform: capitalize; }
        .status-paid { background: #c4f5cd; color: #005c26; }
        .status-pending { background: #ffebd3; color: #8a6116; }
        .status-voided { background: #ffe5e5; color: #d82c0d; }
        
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; }
        .p-item { text-align: center; font-size: 11px; }
        .p-img { width: 100%; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; cursor: zoom-in; transition: transform 0.2s; }
        .p-img:hover { transform: scale(1.05); }
        
        /* Pagination Fixed at Bottom */
        .pagination { 
            display: none; 
            justify-content: center; 
            gap: 10px; 
            padding: 15px; 
            background: white; 
            border-top: 1px solid #e1e3e5; 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 400px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: popIn 0.3s; position: relative; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 24px; color: #666; cursor: pointer; line-height: 1; }
        .modal-close:hover { color: #000; }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #444; }
        .form-group input, .form-group textarea { width: 100%; box-sizing: border-box; }
        .form-group input[readonly], .form-group textarea[readonly] { background-color: #f9fafb; color: #666; cursor: default; }
        
        .row { display: flex; gap: 10px; }
        .hidden { display: none; }
        .warning { color: red; font-size: 11px; margin-top: 2px; }

        .loader { text-align: center; margin-top: 50px; color: #666; }
        
        /* Image Preview Modal */
        .img-preview { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center; flex-direction: column;}
        .img-preview img { max-width:90%; max-height:85%; border-radius:4px; margin-bottom: 10px;}
        
        .preview-controls { position:absolute; top:20px; right:30px; display: flex; gap: 15px; align-items: center; }
        .close-preview { color:white; font-size:35px; cursor:pointer; line-height: 0.8; }

        /* Navigation Arrows */
        .img-nav { position: absolute; top: 50%; transform: translateY(-50%); font-size: 40px; color: white; cursor: pointer; padding: 10px; user-select: none; background: rgba(0,0,0,0.3); border-radius: 5px; }
        .img-nav:hover { background: rgba(0,0,0,0.6); }
        .prev-btn { left: 20px; }
        .next-btn { right: 20px; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes popIn { from {transform: scale(0.9); opacity:0} to {transform: scale(1); opacity:1} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            .sidebar { width: 100%; flex-direction: row; padding: 10px; overflow-x: auto; }
            .menu-item { white-space: nowrap; }
            .top-bar { flex-direction: column; align-items: stretch; }
            .modal-box { width: 90%; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">PFF Premium Orders</div>
        <a href="index.html" class="menu-item active">ðŸ“¦ New Orders</a>
        <a href="OrderList.html" class="menu-item">ðŸ“„ Order List</a>
        <a href="Fulfillment.html" class="menu-item">ðŸšš Fulfillment Entry</a>
    </div>

    <div class="main">
        <div class="top-bar" id="filterBar">
            <input type="text" id="searchId" placeholder="Search Order ID..." style="width: 150px;">
            <select id="statusFilter" onchange="applyFilters()">
                <option value="any" selected>Any Status</option>
                <option value="pending">Payment Pending</option>
                <option value="paid">Paid</option>
                <option value="voided">Voided</option>
            </select>
            <div class="input-group">
                <input type="date" id="dateFrom">
                <span>to</span>
                <input type="date" id="dateTo">
            </div>
            <button class="btn" onclick="applyFilters()">Filter</button>
            <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
        </div>

        <div class="content-area">
            <div id="loader" class="loader">Loading Orders...</div>
            <div id="ordersContainer"></div>
        </div>
        
        <!-- Pagination Fixed Outside Content Area -->
        <div class="pagination" id="paginationControls">
            <button class="btn btn-secondary" id="btnPrev" onclick="changePage('prev')" disabled>Previous</button>
            <span style="font-size:12px; color:#666; display:flex; align-items:center;">&nbsp; 50 Orders / Page &nbsp;</span>
            <button class="btn btn-secondary" id="btnNext" onclick="changePage('next')" disabled>Next</button>
        </div>
    </div>

    <div id="toast"></div>

    <!-- Modals -->
    <div id="addModal" class="modal">
        <div class="modal-box">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div class="modal-title">Add to Order List</div>
            <input type="hidden" id="m_orderId">
            <input type="hidden" id="m_orderDate">
            <input type="hidden" id="m_amount">

            <div class="form-group">
                <label>Customer Number (11 Digits)</label>
                <div class="row">
                    <input type="number" id="cNumber" placeholder="017xxxxxxxx" onkeypress="handleEnter(event)">
                    <button class="btn btn-secondary" id="btnCheck" onclick="checkCustomer()">Check</button>
                </div>
                <div id="numWarning" class="warning"></div>
            </div>

            <div id="customerDetails" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="font-size:12px; font-weight:600; color:#444;">Details</span>
                    <!-- Update Button -->
                    <button id="btnTriggerUpdate" class="btn btn-sm btn-secondary" style="display:none;" onclick="enableUpdateMode()">Update</button>
                </div>
                
                <div class="form-group">
                    <label>Customer Name</label>
                    <input type="text" id="cName">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="cAddress" rows="2"></textarea>
                </div>
                <!-- Note Input REMOVED -->
                
                <div style="text-align: right; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn" id="btnUpdateData" onclick="performCustomerUpdate()" style="display:none; background:#008060; color:white;">Update Data</button>
                    <button class="btn" id="btnSave" onclick="saveToSheet()">Save to List</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview with Navigation -->
    <div id="imgPreview" class="img-preview" onclick="if(event.target === this) this.style.display='none'">
        <div class="preview-controls">
            <span class="close-preview" onclick="document.getElementById('imgPreview').style.display='none'">&times;</span>
        </div>
        <span class="img-nav prev-btn" id="prevBtn" onclick="navigatePreview(-1)">&#10094;</span>
        <img id="previewImgSrc" src="">
        <span class="img-nav next-btn" id="nextBtn" onclick="navigatePreview(1)">&#10095;</span>
    </div>

    <script>
        // ===========================================
        // CONFIG
        // ===========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzEf-503JgVRQGLSaFFz8CHjSbJlmTX-UNnyjUiS6yyjk-JGqavucbmnnc_do9C69rb/exec"; 
        
        let nextPageCursor = "";
        let prevPageCursor = "";
        let isNewCustomer = false;
        let searchTimeout;
        let currentPreviewImages = [];
        let currentPreviewIndex = 0;

        window.onload = function() {
            document.getElementById('statusFilter').value = 'any';
            fetchOrders();
            document.getElementById('searchId').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 1000);
            });
        };

        function switchTab(tab) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            const content = document.getElementById('ordersContainer');
            const filterBar = document.getElementById('filterBar');
            const pagination = document.getElementById('paginationControls');
            
            if (tab === 'new') {
                filterBar.style.display = 'flex';
                // Don't show pagination immediately, let fetchOrders handle it
                fetchOrders();
            } else if (tab === 'list') {
                filterBar.style.display = 'none';
                pagination.style.display = 'none';
                content.innerHTML = '<div class="loader">Order List Feature Coming Soon...</div>';
            } else if (tab === 'fulfillment') {
                filterBar.style.display = 'none';
                pagination.style.display = 'none';
                content.innerHTML = '<div class="loader">Fulfillment Entry Feature Coming Soon...</div>';
            }
        }

        async function fetchOrders(cursor = "") {
            const container = document.getElementById('ordersContainer');
            const loader = document.getElementById('loader');
            const pagination = document.getElementById('paginationControls');
            
            container.innerHTML = '';
            loader.style.display = 'block';
            pagination.style.display = 'none'; // HIDE PAGINATION WHEN LOADING

            const status = document.getElementById('statusFilter').value;
            const searchId = document.getElementById('searchId').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            let url = `${SCRIPT_URL}?action=getOrders&status=${status}`;
            if (searchId) url += `&name=${searchId}`;
            if (dateFrom) url += `&created_at_min=${dateFrom}T00:00:00`;
            if (dateTo) url += `&created_at_max=${dateTo}T23:59:59`;
            if (cursor) url += `&page_info=${cursor}`;

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
                const data = await res.json();
                
                loader.style.display = 'none';
                
                if (data.status === 'success') {
                    renderOrders(data.orders, data.images, data.savedIds || []);
                    
                    nextPageCursor = data.nextPage || "";
                    prevPageCursor = data.prevPage || "";
                    document.getElementById('btnNext').disabled = !nextPageCursor;
                    document.getElementById('btnPrev').disabled = !prevPageCursor;
                    
                    // SHOW PAGINATION AFTER SUCCESS
                    pagination.style.display = 'flex';
                } else {
                    container.innerHTML = `<div style="text-align:center;color:red;">Error: ${data.message}</div>`;
                }
            } catch (err) {
                loader.style.display = 'none';
                container.innerHTML = `<div style="text-align:center;color:red;">Connection Error. Check Deploy URL & Permissions.</div>`;
            }
        }

        function renderOrders(orders, images, savedIds) {
            const container = document.getElementById('ordersContainer');
            if (orders.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:20px;">No orders found.<br>Try Changing Filters.</div>';
                return;
            }

            let html = '';
            orders.forEach(order => {
                const dateObj = new Date(order.created_at);
                const date = dateObj.toLocaleDateString("en-GB");
                const dayName = dateObj.toLocaleDateString("en-US", { weekday: 'long' });
                
                let fStatus = order.financial_status || 'pending';
                let statusClass = 'status-pending';
                if(fStatus === 'paid') statusClass = 'status-paid';
                if(fStatus === 'voided') statusClass = 'status-voided';

                let productHtml = '';
                let imageUrls = [];

                order.line_items.forEach(item => {
                    let img = 'https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png';
                    if (item.product_id && images[item.product_id]) {
                        img = images[item.product_id];
                        imageUrls.push(img);
                    }
                    const allImagesStr = JSON.stringify(imageUrls).replace(/"/g, '&quot;');
                    const currentIndex = imageUrls.length - 1;
                    productHtml += `
                        <div class="p-item">
                            <img src="${img}" class="p-img" onclick="showPreview('${allImagesStr}', ${currentIndex})">
                            <div>${item.quantity}x</div>
                        </div>`;
                });
                
                productHtml = '';
                imageUrls = [];
                order.line_items.forEach(item => {
                    if (item.product_id && images[item.product_id]) imageUrls.push(images[item.product_id]);
                });
                const allImagesStr = JSON.stringify(imageUrls).replace(/"/g, '&quot;');
                let imgIndex = 0;
                order.line_items.forEach(item => {
                    let img = 'https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png';
                    let clickHandler = '';
                    if (item.product_id && images[item.product_id]) {
                        img = images[item.product_id];
                        clickHandler = `onclick="showPreview(${allImagesStr}, ${imgIndex})"`;
                        imgIndex++;
                    }
                    productHtml += `
                        <div class="p-item">
                            <img src="${img}" class="p-img" ${clickHandler}>
                            <div>${item.quantity}x</div>
                        </div>`;
                });

                let downloadActionBtn = '';
                if (imageUrls.length > 0) {
                    const btnText = imageUrls.length === 1 ? 'Download Image' : 'Download All Images';
                    downloadActionBtn = `<button class="btn btn-secondary btn-sm" onclick="downloadAllImages(${allImagesStr}, '${order.order_number}')">${btnText}</button>`;
                }

                let orderIdStr = String(order.order_number);
                let addToSheetBtn;
                if (savedIds.includes(orderIdStr)) {
                    addToSheetBtn = `<button class="btn btn-disabled" disabled>Already Listed</button>`;
                } else {
                    addToSheetBtn = `<button class="btn" onclick="openAddModal('${order.order_number}', '${date}', '${order.total_price}')">Add to List</button>`;
                }

                html += `
                <div class="order-card">
                    <div class="order-header">
                        <div><div class="order-id">#${order.order_number}</div><div class="order-date">${date}<div style="font-size: 11px; color: #8c9196; margin-top: 2px;">${dayName}</div></div></div>
                        <div class="order-actions"><div class="price-tag">${order.total_price}</div>${addToSheetBtn}<span class="status-badge ${statusClass}">${fStatus}</span>${downloadActionBtn}</div>
                    </div>
                    <div class="product-grid">${productHtml}</div>
                </div>`;
            });
            document.getElementById('ordersContainer').innerHTML = html;
        }

        function openAddModal(id, date, amount) {
            document.getElementById('addModal').style.display = 'flex';
            document.getElementById('m_orderId').value = id;
            document.getElementById('m_orderDate').value = date;
            document.getElementById('m_amount').value = amount;
            
            document.getElementById('cNumber').value = '';
            document.getElementById('cName').value = '';
            document.getElementById('cAddress').value = '';
            document.getElementById('customerDetails').classList.add('hidden');
            document.getElementById('numWarning').innerText = '';
            
            // Reset UI
            document.getElementById('btnTriggerUpdate').style.display = 'none';
            document.getElementById('btnUpdateData').style.display = 'none';
            document.getElementById('btnSave').style.display = 'inline-block';
            setInputsReadOnly(false);
            
            document.getElementById('addModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('addModal').style.display = 'none'; }
        
        function handleEnter(e) { 
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                document.getElementById('btnCheck').click(); 
            } 
        }

        async function checkCustomer() {
            let numInput = document.getElementById('cNumber').value;
            let num = numInput.toString();
            const warning = document.getElementById('numWarning');
            if (num.length !== 11) { warning.innerText = 'âš ï¸ Number must be exactly 11 digits'; return; }
            else { warning.innerText = ''; }
            if (!num.startsWith('0')) num = '0' + num;

            const btn = document.getElementById('btnCheck');
            const originalText = btn.innerText;
            btn.innerText = 'Checking...'; btn.disabled = true;
            
            try {
                const url = `${SCRIPT_URL}?action=checkCustomer&phone=${num}`;
                const res = await fetch(url, { method: 'GET', redirect: 'follow' });
                if (!res.ok) throw new Error("Server Response Error");
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);

                document.getElementById('customerDetails').classList.remove('hidden');
                
                if (data.found) {
                    // Customer Found: Auto-fill and Lock
                    document.getElementById('cName').value = data.name;
                    document.getElementById('cAddress').value = data.address;
                    isNewCustomer = false;
                    
                    setInputsReadOnly(true); 
                    document.getElementById('btnTriggerUpdate').style.display = 'block'; // Show Edit button
                    document.getElementById('btnUpdateData').style.display = 'none';
                    document.getElementById('btnSave').style.display = 'inline-block';
                } else {
                    // Not Found: Clear and Unlock
                    document.getElementById('cName').value = '';
                    document.getElementById('cAddress').value = '';
                    document.getElementById('cName').placeholder = 'New Customer Name';
                    document.getElementById('cAddress').placeholder = 'Enter Address';
                    isNewCustomer = true;
                    
                    setInputsReadOnly(false); // Unlock
                    document.getElementById('btnTriggerUpdate').style.display = 'none';
                    document.getElementById('btnUpdateData').style.display = 'none';
                    document.getElementById('btnSave').style.display = 'inline-block';
                }
            } catch (err) { 
                console.error("Check Customer Error:", err);
                showToast("Connection Failed."); 
            } finally { 
                btn.innerText = originalText; btn.disabled = false; 
            }
        }

        function setInputsReadOnly(state) {
            document.getElementById('cName').readOnly = state;
            document.getElementById('cAddress').readOnly = state;
        }

        function enableUpdateMode() {
            setInputsReadOnly(false);
            document.getElementById('btnTriggerUpdate').style.display = 'none'; 
            document.getElementById('btnSave').style.display = 'none';
            document.getElementById('btnUpdateData').style.display = 'inline-block';
            showToast("You can now update details");
        }

        async function performCustomerUpdate() {
            const btn = document.getElementById('btnUpdateData');
            btn.innerText = 'Updating...'; btn.disabled = true;
            let cNumber = '0' + parseInt(document.getElementById('cNumber').value);
            let cName = document.getElementById('cName').value;
            let cAddress = document.getElementById('cAddress').value;
            if(!cName || !cAddress) { showToast("Name and Address required"); btn.innerText = 'Update Data'; btn.disabled = false; return; }

            const qs = new URLSearchParams({ action: 'updateCustomerOnly', cNumber: cNumber, cName: cName, cAddress: cAddress }).toString();
            try {
                const res = await fetch(SCRIPT_URL + '?' + qs, { method: 'GET', redirect: 'follow' });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast(data.message);
                    document.getElementById('btnUpdateData').style.display = 'none';
                    document.getElementById('btnSave').style.display = 'inline-block';
                    setInputsReadOnly(true);
                    document.getElementById('btnTriggerUpdate').style.display = 'block';
                } else { showToast(data.message); }
            } catch(e) { showToast("Update Failed"); }
            btn.innerText = 'Update Data'; btn.disabled = false;
        }

        async function saveToSheet() {
            const btn = document.getElementById('btnSave');
            btn.innerText = 'Saving...'; btn.disabled = true;
            let rawNum = document.getElementById('cNumber').value;
            let finalNum = rawNum.startsWith('0') ? rawNum : '0' + rawNum;

            const payload = {
                action: 'saveOrder',
                oID: document.getElementById('m_orderId').value,
                oDate: document.getElementById('m_orderDate').value,
                oAmount: document.getElementById('m_amount').value,
                cNumber: finalNum, 
                cName: document.getElementById('cName').value,
                cAddress: document.getElementById('cAddress').value,
                oNote: "", // No Note
                isNewCustomer: isNewCustomer
            };

            if(!payload.cName || !payload.cAddress) {
                showToast("Please fill Name and Address");
                btn.innerText = 'Save to List'; btn.disabled = false; return;
            }

            try {
                const res = await fetch(SCRIPT_URL + '?' + new URLSearchParams(payload).toString(), {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                const data = await res.json();
                if (data.status === 'error') {
                    showToast(data.message); 
                } else {
                    showToast("âœ… Saved to Order List!");
                    closeModal();
                    fetchOrders();
                }
            } catch(e) { 
                showToast("Error saving."); 
            }
            btn.innerText = 'Save to List'; btn.disabled = false;
        }

        function showToast(msg) {
            var x = document.getElementById("toast");
            x.className = "show"; x.innerText = msg;
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        function showPreview(images, index) {
            if(typeof images === 'string') {
                currentPreviewImages = [images];
                currentPreviewIndex = 0;
            } else {
                currentPreviewImages = images;
                currentPreviewIndex = index;
            }
            updatePreviewImage();
            document.getElementById('imgPreview').style.display = 'flex';
        }

        function navigatePreview(direction) {
            let newIndex = currentPreviewIndex + direction;
            if(newIndex >= 0 && newIndex < currentPreviewImages.length) {
                currentPreviewIndex = newIndex;
                updatePreviewImage();
            }
        }

        function updatePreviewImage() {
            document.getElementById('previewImgSrc').src = currentPreviewImages[currentPreviewIndex];
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            if(currentPreviewImages.length > 1) {
                prevBtn.style.display = currentPreviewIndex > 0 ? 'block' : 'none';
                nextBtn.style.display = currentPreviewIndex < currentPreviewImages.length - 1 ? 'block' : 'none';
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            }
        }

        // Helper to force download cross-origin images
        async function forceDownload(url, fileName) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(blobUrl);
            } catch (e) {
                console.error("Download failed", e);
                window.open(url, '_blank');
            }
        }

        // Download All (or Single) Images for an Order
        async function downloadAllImages(urls, orderId) {
            if(urls.length === 1) {
                showToast(`Downloading image...`);
            } else {
                showToast(`Downloading ${urls.length} images...`);
            }
            
            for (let i = 0; i < urls.length; i++) {
                let fileName = urls.length === 1 ? `Order-${orderId}.jpg` : `Order-${orderId}-Img-${i+1}.jpg`;
                await forceDownload(urls[i], fileName);
                if(urls.length > 1) { await new Promise(r => setTimeout(r, 500)); }
            }
        }

    </script>
</body>
</html>
